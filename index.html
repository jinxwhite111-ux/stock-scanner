<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Stock Scanner</title>

  <!-- Load Quagga2 -->
  <script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>

  <style>
    body { font-family: Arial; text-align: center; margin: 0; }
    #scanner { width: 100%; height: 65vh; background: #111; }
    button { font-size: 18px; padding: 12px; margin: 6px; width: 45%; }
    input { font-size: 18px; padding: 8px; width: 80%; }
    #status { padding: 10px; font-size: 14px; }
    #small { font-size: 12px; opacity: 0.8; margin-top: 6px; }
  </style>
</head>

<body>
  <h2>Stock Scan</h2>

  <div>
    <button id="inBtn">SCAN IN</button>
    <button id="outBtn">SCAN OUT</button>
  </div>

  <p>Quantity</p>
  <input id="qty" type="number" min="1" value="1"/>

  <div id="scanner"></div>

  <p id="status">Tap SCAN IN or SCAN OUT to start camera.</p>
  <p id="small">If camera doesnâ€™t open: Chrome Site Settings â†’ Camera â†’ Allow.</p>

  <!-- IMPORTANT: script is at the bottom so buttons exist -->
  <script>
    // âœ… Paste your Apps Script Web App URL here
    // Example: https://script.google.com/macros/s/XXXXX/exec
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwxx_qBja2P_5um5nkTVA78T5TVJY1DoA9GMycWWQxolrygKu_PayOIBw5MbEbkFL8Wcg/exec";

    let ACTION = 'IN';
    let scannerRunning = false;
    let lastDetectedAt = 0;

    const statusEl = document.getElementById('status');

    // If Quagga failed to load, clicks will do nothing unless we show it
    if (!window.Quagga) {
      statusEl.innerText = "ERROR: Scanner library didn't load (Quagga missing). Check connection/adblock.";
    }

    document.getElementById('inBtn').addEventListener('click', () => start('IN'));
    document.getElementById('outBtn').addEventListener('click', () => start('OUT'));

    function start(mode) {
      ACTION = mode;
      statusEl.innerText = `Mode: ${mode} â€” requesting camera...`;
      startScanner();
    }

    async function startScanner() {
      if (scannerRunning) return;
      scannerRunning = true;

      // Force camera prompt on tap
      try {
        await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: "environment" },
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        });
      } catch (err) {
        scannerRunning = false;
        statusEl.innerText = "Camera blocked. Chrome: ðŸ”’ â†’ Site settings â†’ Camera â†’ Allow.";
        console.error(err);
        return;
      }

      Quagga.init({
        inputStream: {
          type: "LiveStream",
          target: document.querySelector('#scanner'),
          constraints: {
            facingMode: { ideal: "environment" },
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        },
        locator: { halfSample: true, patchSize: "medium" },
        numOfWorkers: navigator.hardwareConcurrency ? Math.min(4, navigator.hardwareConcurrency) : 2,
        frequency: 10,
        decoder: { readers: ["code_128_reader"], multiple: false },
        locate: true
      }, function(err) {
        if (err) {
          scannerRunning = false;
          statusEl.innerText = "Scanner init failed. Open console for error.";
          console.error(err);
          return;
        }
        Quagga.start();
        statusEl.innerText = `Mode: ${ACTION} â€” scanning...`;
      });
    }

    function stopScanner() {
      try { Quagga.stop(); } catch(e) {}
      scannerRunning = false;
    }

    Quagga.onDetected(function(result) {
      const code = result?.codeResult?.code;
      if (!code) return;

      const now = Date.now();
      if (now - lastDetectedAt < 1200) return;
      lastDetectedAt = now;

      stopScanner();
      statusEl.innerText = `Scanned: ${code} â€” saving...`;
      sendScan(code);
    });

    function sendScan(sku) {
      const qty = Number(document.getElementById('qty').value || 1);

      fetch(WEB_APP_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sku, action: ACTION, qty })
      })
      .then(r => r.json())
      .then(res => {
        if (res.ok) {
          statusEl.innerText = `Recorded: ${ACTION} ${qty} Ã— ${sku}. Tap IN/OUT to scan again.`;
        } else {
          statusEl.innerText = "Error saving scan: " + (res.error || "Unknown error");
        }
      })
      .catch(err => {
        statusEl.innerText = "Network error posting to Sheets: " + err;
      });
    }
  </script>
</body>
</html>
