<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Stock Scanner</title>
  <script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>
  <style>
    body { font-family: Arial; text-align: center; margin: 0; }
    #scanner { width: 100%; height: 60vh; }
    button { font-size: 18px; padding: 12px; margin: 6px; width: 45%; }
    input { font-size: 18px; padding: 8px; width: 80%; }
  </style>
</head>

<body>
  <h2>Stock Scan</h2>

  <div>
    <button onclick="setAction('IN')">SCAN IN</button>
    <button onclick="setAction('OUT')">SCAN OUT</button>
  </div>

  <p>Quantity</p>
  <input id="qty" type="number" min="1" value="1"/>

  <div id="scanner"></div>

  <p id="status"></p>

<script>
const WEB_APP_URL = "PASTE_YOUR_WEB_APP_URL_HERE";
let ACTION = 'IN';
let scannerRunning = false;

const statusEl = document.getElementById('status');

function setAction(a) {
  ACTION = a;
  statusEl.innerText = `Mode: ${a} — starting camera...`;
  startScanner(); // IMPORTANT: start camera only on button tap
}

function startScanner() {
  if (scannerRunning) return;
  scannerRunning = true;

  Quagga.init({
    inputStream: {
      type: "LiveStream",
      target: document.querySelector('#scanner'),
      constraints: {
        facingMode: { ideal: "environment" } // back camera preferred
      }
    },
    decoder: {
      readers: ["code_128_reader"]
    },
    locate: true
  }, function(err) {
    if (err) {
      scannerRunning = false;
      statusEl.innerText =
        "Camera failed to start. Check Safari camera permissions + HTTPS.";
      console.error(err);
      return;
    }
    Quagga.start();
    statusEl.innerText = `Mode: ${ACTION} — camera running. Scan a barcode...`;
  });
}

function stopScanner() {
  try { Quagga.stop(); } catch(e) {}
  scannerRunning = false;
}

Quagga.onDetected(function(result) {
  const sku = result?.codeResult?.code;
  if (!sku) return;

  stopScanner();
  statusEl.innerText = `Scanned: ${sku} — saving...`;
  sendScan(sku);
});

function sendScan(sku) {
  const qty = Number(document.getElementById('qty').value || 1);

  fetch(WEB_APP_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ sku, action: ACTION, qty })
  })
  .then(r => r.json())
  .then(res => {
    if (res.ok) {
      statusEl.innerText = `Recorded: ${ACTION} ${qty} × ${sku}. Tap IN/OUT to scan again.`;
    } else {
      statusEl.innerText = "Error saving scan: " + (res.error || "Unknown");
    }
  })
  .catch(err => {
    statusEl.innerText = "Network error: " + err;
  });
}
</script>
</body>
</html>

